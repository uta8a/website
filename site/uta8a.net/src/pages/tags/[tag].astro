---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const toChangelogDate = (date?: string): number => {
    const value = Date.parse(date ?? "");
    return Number.isNaN(value) ? 0 : value;
  };

  const posts = (await getCollection("posts")).filter((post) => !post.data.draft);
  const tags = new Set<string>();

  for (const post of posts) {
    for (const tag of post.data.tag) {
      tags.add(tag);
    }
  }

  return [...tags].map((tag) => ({
    params: { tag: encodeURIComponent(tag) },
    props: {
      tag,
      posts: posts
        .filter((post) => post.data.tag.includes(tag))
        .sort((a, b) => toChangelogDate(b.data.changelog[0]?.date) - toChangelogDate(a.data.changelog[0]?.date)),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<BaseLayout title={`Tag: ${tag}`} description={`Posts tagged with ${tag}`}>
  <h1>Tag: {tag}</h1>
  <ul>
    {posts.map((post) => (
      <li>
        <a href={`/${post.slug}/`}>{post.data.title}</a>
        <span class="meta"> ({post.slug})</span>
      </li>
    ))}
  </ul>
</BaseLayout>
