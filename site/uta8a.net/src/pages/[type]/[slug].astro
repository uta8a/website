---
import { getCollection, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = (await getCollection("posts")).filter((post) => !post.data.draft);
  return posts
    .map((post) => {
      const [type, slug] = post.slug.split("/");
      if (!type || !slug) return null;
      return { params: { type, slug }, props: { post } };
    })
    .filter((v): v is { params: { type: string; slug: string }; props: { post: (typeof posts)[number] } } => v !== null);
}

const { post } = Astro.props;
const { Content } = await render(post);
const [type, slug] = post.slug.split("/");
const isBlog = type === "blog";
const ogImage = isBlog && slug ? `/og/${type}/${slug}.png` : (slug ? `/posts/${slug}/${post.data.ogp}` : undefined);
---

<BaseLayout title={post.data.title} description={post.data.description} ogImage={ogImage} ogType="article">
  <article class={isBlog ? "blog-article" : undefined} aria-labelledby="post-title">
    {isBlog && <p class="kicker">UTA8A BLOG</p>}
    <header>
      <h1 id="post-title">{post.data.title}</h1>
      <ul class="meta tag-list" aria-label="Tags">
        {post.data.tag.map((tag) => (
          <li><a href={`/tags/${encodeURIComponent(tag)}/`}>#{tag}</a></li>
        ))}
      </ul>
      {isBlog && <p class="back"><a href="/blog/" aria-label="Back to blog top page">‚Üê Back to Blog</a></p>}
    </header>

    <div class={isBlog ? "content content-blog" : "content"} aria-label="Article body">
      <Content />
    </div>

    {isBlog && (
      <details class="post-meta-box">
        <summary>Revision History & Contact</summary>
        <h2 class="visually-hidden">Revision history</h2>
        <ul aria-label="Changelog entries">
          {post.data.changelog.map((item) => (
            <li>
              <strong>{item.summary}</strong>
              <time class="meta" datetime={item.date}>{item.date}</time>
            </li>
          ))}
        </ul>
        <p>
          Contact: <a href="/contact">uta8a.net/contact</a>
        </p>
      </details>
    )}
  </article>
</BaseLayout>

<style>
  .blog-article {
    padding-top: clamp(1rem, 3vw, 2.2rem);
  }

  .kicker {
    margin: 0 0 0.2rem;
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    color: #5f6670;
  }

  h1 {
    margin: 0;
    font-size: clamp(2rem, 5vw, 3.2rem);
    line-height: 1.07;
    letter-spacing: -0.02em;
  }

  .back {
    margin: 0.65rem 0 0;
  }

  .tag-list {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    gap: 0.55rem;
    margin: 0.45rem 0 0;
    padding: 0;
  }

  .content {
    margin-top: 1.1rem;
  }

  .content-blog {
    font-family: "Iowan Old Style", "Palatino Linotype", Palatino, "Times New Roman", serif;
    font-size: clamp(1.06rem, 2vw, 1.16rem);
    line-height: 1.85;
    max-width: 68ch;
  }

  .content-blog :global(h1),
  .content-blog :global(h2),
  .content-blog :global(h3) {
    font-family: "Inter", "Segoe UI", "Helvetica Neue", sans-serif;
    line-height: 1.25;
    margin-top: 1.7em;
    margin-bottom: 0.55em;
  }

  .content-blog :global(h1) {
    font-size: clamp(1.45rem, 3.1vw, 1.72rem);
    line-height: 1.3;
    margin-top: 1.5em;
  }

  .content-blog :global(h2) {
    font-size: clamp(1.22rem, 2.8vw, 1.42rem);
  }

  .content-blog :global(h3) {
    font-size: clamp(1.08rem, 2.3vw, 1.24rem);
  }

  .content-blog :global(h4) {
    font-family: "Inter", "Segoe UI", "Helvetica Neue", sans-serif;
    font-size: clamp(0.98rem, 2vw, 1.1rem);
    line-height: 1.42;
    margin-top: 1.3em;
    margin-bottom: 0.45em;
  }

  .content-blog :global(p) {
    margin: 0 0 1.05em;
  }

  .content-blog :global(pre) {
    margin: 1.2em 0 1.35em;
    padding: 1.1rem 1.25rem;
    border-radius: 13px;
    border: 1px solid #343f4c;
    background: linear-gradient(180deg, #242d39 0%, #1a212c 100%);
    box-shadow: inset 0 1px 0 #ffffff1f;
    color: #e7edf6;
    overflow-x: auto;
  }

  .content-blog :global(pre code) {
    padding: 0;
    border: 0;
    background: transparent;
    font-size: 0.9rem;
    line-height: 1.68;
    color: inherit;
    font-weight: 500;
  }

  .content-blog :global(pre.astro-code span) {
    color: var(--shiki-dark, var(--shiki-light, #e7edf6)) !important;
    background-color: transparent !important;
  }

  .content-blog :global(code) {
    padding: 0.14em 0.4em;
    border-radius: 6px;
    border: 1px solid #e0d7cb;
    background: #f5efe5;
    font-size: 0.88em;
  }

  .post-meta-box {
    margin-top: 2.4rem;
    padding: 0.85rem 1rem;
    border: 1px solid #ddd6cb;
    border-radius: 10px;
    background: #fffefb;
  }

  .post-meta-box summary {
    cursor: pointer;
    font-weight: 600;
  }

  .post-meta-box ul {
    margin: 0.75rem 0 0;
    padding-left: 1.1rem;
  }

  .post-meta-box li + li {
    margin-top: 0.35rem;
  }
</style>
